import shutil
import os
import random
from subprocess import check_call

from core.util import makedirs_to_path, recursive_permissions_on_path
from prequeue.handlers import preview_converter


# converts to svg for consistency
# svgz     - compressed
# dia      - diagram (Dia)
# ai       - illustrator
# wpf      -
# wpm      -
# sk1      - 
# plt      - HP autocad
# outline  - text outline file


@preview_converter(('svgz', 'dia', 'ai', 'wpf', 'wpm', 'sk1', 'plt', 'outline'), 'svg')
def inkscape_converter(in_path, out_path):
    # Converts SVG to PNG
    return check_call(["inkscape", "-z", "-f", in_path, "-e", out_path])

@preview_converter(('svg',), 'png')
def inkscape_renderer(in_path, out_path):
    # Converts SVG to PNG
    return check_call(["inkscape", "-z", "-f", in_path, "-e", out_path])

def _unoconv(in_path, out_path):
    base_path, ext = os.path.splitext(out_path)
    in_base_path, in_ext = os.path.splitext(in_path)

    # do the actual conversion
    res = check_call(["unoconv", "-f", ext.strip("."), in_path])

    # unoconv by default just puts it in the same directory, so lets move it to
    # the desired filename
    new_path = in_base_path + ext
    if new_path != out_path:
        shutil.move(new_path, out_path)
    return res

# step 1 is to get it to pdf
@preview_converter(('odt', 'odg', 'odp', 'odf'), 'pdf')
def unoconv_renderer(in_path, out_path):
    # Converts ODT to PNG
    #return check_call(["unoconv", "-f", "png", in_path])
    return _unoconv(in_path, out_path)


# step 2 is to get it to png
FIRST_PAGE_CONVERT = "%s[0]" 
@preview_converter(('pdf',), 'png')
def convert_render(in_path, out_path):
    # Converts ODT to PNG
    #return check_call(["unoconv", "-f", "png", in_path])
    return check_call(["convert", FIRST_PAGE_CONVERT % in_path, out_path])


@preview_converter(('dxf',), 'svg', keep=True)
def convert_dxf(in_path, out_path):
    # Converts DXF to SVG

    # All of these shenanigans are because it can't handle spaces in the
    # filename

    # Kabeja dies if there are spaces in the file name (yeap.... >_>)
    # So lets make temporary files in /tmp/ with random name which will for
    # sure not have spaces, then move them when we are done
    tmp_fn = "%010X" % random.randint(0, 999999999999)
    in_path_link = os.path.join("/tmp", "openlab_preview_converter", tmp_fn+".dxf")
    out_path_tmp = os.path.join("/tmp", "openlab_preview_converter", tmp_fn+".svg")
    makedirs_to_path(in_path_link) # Make sure the directory exists

    check_call(["ln", "-s", in_path, in_path_link])
    res = check_call(["kabeja", "-nogui", "-pipeline", "svg", in_path_link, out_path_tmp])
    shutil.move(out_path_tmp, out_path)
    os.remove(in_path_link)

    return res



'''
@preview_converter(('bib', 'doc', 'ott', 'rtf', 'latex', 'xml', 'sdw', 'stw', 'sxw', 'uot', 'vor'), 'pdf', keep=True)
def unoconv_converter_odt(in_path, out_path):
    # Converts Doc types to ODT
    return check_call(["unoconv", "-f", "odt", in_path])

@preview_converter(('ppt', 'sda', 'sdd', 'sxd', 'sti', 'svm', 'sxi', 'uop', 'vor'), 'pdf', keep=True)
def unoconv_converter_odp(in_path, out_path):
    # Converts Presentations to ODP
    return check_call(["unoconv", "-f", "odp", in_path])

@preview_converter(('csv', 'dbf', 'dif', 'sdc', 'slk', 'stc', 'sxc', 'xls', 'xlt'), 'pdf', keep=True)
def unoconv_converter_ods(in_path, out_path):
    # Converts Spreadsheets / data to ODS
    return check_call(["unoconv", "-f", "ods", in_path])
'''

#  pdf      - Portable Document Format [.pdf]
UNOCONV_HELP = '''
The following list of document formats are currently available:
  bib      - BibTeX [.bib]
  doc      - Microsoft Word 97/2000/XP [.doc]
  doc6     - Microsoft Word 6.0 [.doc]
  doc95    - Microsoft Word 95 [.doc]
  docbook  - DocBook [.xml]
  html     - HTML Document (OpenOffice.org Writer) [.html]
  odt      - ODF Text Document [.odt]
  ott      - Open Document Text [.ott]
  ooxml    - Microsoft Office Open XML [.xml]
  rtf      - Rich Text Format [.rtf]
  latex    - LaTeX 2e [.ltx]
  sdw      - StarWriter 5.0 [.sdw]
  sdw4     - StarWriter 4.0 [.sdw]
  sdw3     - StarWriter 3.0 [.sdw]
  stw      - Open Office.org 1.0 Text Document Template [.stw]
  sxw      - Open Office.org 1.0 Text Document [.sxw]
  text     - Text Encoded [.txt]
  mediawiki - MediaWiki [.txt]
  txt      - Text [.txt]
  uot      - Unified Office Format text [.uot]
  vor      - StarWriter 5.0 Template [.vor]
  vor4     - StarWriter 4.0 Template [.vor]
  vor3     - StarWriter 3.0 Template [.vor]
  xhtml    - XHTML Document [.html]

The following list of graphics formats are currently available:

  emf      - Enhanced Metafile [.emf]
  eps      - Encapsulated PostScript [.eps]
  html     - HTML Document (OpenOffice.org Draw) [.html]
'''
#tiff     - Tagged Image File Format [.tiff]
#svg      - Scalable Vector Graphics [.svg]
#jpg      - Joint Photographic Experts Group [.jpg]
#png      - Portable Network Graphic [.png]
#gif      - Graphics Interchange Format [.gif]
#bmp      - Windows Bitmap [.bmp]
#svg      - Scalable Vector Graphics [.svg]

UNOCONV_HELP += '''
  met      - OS/2 Metafile [.met]
  odd      - OpenDocument Drawing [.odd]
  otg      - OpenDocument Drawing Template [.otg]
  pbm      - Portable Bitmap [.pbm]
  pct      - Mac Pict [.pct]
  pgm      - Portable Graymap [.pgm]
  ppm      - Portable Pixelmap [.ppm]
  ras      - Sun Raster Image [.ras]
  std      - OpenOffice.org 1.0 Drawing Template [.std]
  svm      - StarView Metafile [.svm]
  swf      - Macromedia Flash (SWF) [.swf]
  sxd      - OpenOffice.org 1.0 Drawing [.sxd]
  sxd3     - StarDraw 3.0 [.sxd]
  sxd5     - StarDraw 5.0 [.sxd]
  vor      - StarDraw 5.0 Template [.vor]
  vor3     - StarDraw 3.0 Template [.vor]
  wmf      - Windows Metafile [.wmf]
  xhtml    - XHTML [.xhtml]
  xpm      - X PixMap [.xpm]

The following list of presentation formats are currently available:

  bmp      - Windows Bitmap [.bmp]
  emf      - Enhanced Metafile [.emf]
  eps      - Encapsulated PostScript [.eps]
  html     - HTML Document (OpenOffice.org Impress) [.html]
  met      - OS/2 Metafile [.met]
  odg      - ODF Drawing (Impress) [.odg]
  odp      - ODF Presentation [.odp]
  otp      - ODF Presentation Template [.otp]
  pbm      - Portable Bitmap [.pbm]
  pct      - Mac Pict [.pct]
  pgm      - Portable Graymap [.pgm]
  pot      - Microsoft PowerPoint 97/2000/XP Template [.pot]
  ppm      - Portable Pixelmap [.ppm]
  ppt      - Microsoft PowerPoint 97/2000/XP [.ppt]
  pwp      - PlaceWare [.pwp]
  ras      - Sun Raster Image [.ras]
  sda      - StarDraw 5.0 (OpenOffice.org Impress) [.sda]
  sdd      - StarImpress 5.0 [.sdd]
  sdd3     - StarDraw 3.0 (OpenOffice.org Impress) [.sdd]
  sdd4     - StarImpress 4.0 [.sdd]
  sxd      - OpenOffice.org 1.0 Drawing (OpenOffice.org Impress) [.sxd]
  sti      - OpenOffice.org 1.0 Presentation Template [.sti]
  svm      - StarView Metafile [.svm]
  swf      - Macromedia Flash (SWF) [.swf]
  sxi      - OpenOffice.org 1.0 Presentation [.sxi]
  uop      - Unified Office Format presentation [.uop]
  vor      - StarImpress 5.0 Template [.vor]
  vor3     - StarDraw 3.0 Template (OpenOffice.org Impress) [.vor]
  vor4     - StarImpress 4.0 Template [.vor]
  vor5     - StarDraw 5.0 Template (OpenOffice.org Impress) [.vor]
  wmf      - Windows Metafile [.wmf]
  xhtml    - XHTML [.xml]
  xpm      - X PixMap [.xpm]

The following list of spreadsheet formats are currently available:

  csv      - Text CSV [.csv]
  dbf      - dBASE [.dbf]
  dif      - Data Interchange Format [.dif]
  html     - HTML Document (OpenOffice.org Calc) [.html]
  ods      - ODF Spreadsheet [.ods]
  ooxml    - Microsoft Excel 2003 XML [.xml]
  ots      - ODF Spreadsheet Template [.ots]
  sdc      - StarCalc 5.0 [.sdc]
  sdc4     - StarCalc 4.0 [.sdc]
  sdc3     - StarCalc 3.0 [.sdc]
  slk      - SYLK [.slk]
  stc      - OpenOffice.org 1.0 Spreadsheet Template [.stc]
  sxc      - OpenOffice.org 1.0 Spreadsheet [.sxc]
  uos      - Unified Office Format spreadsheet [.uos]
  vor3     - StarCalc 3.0 Template [.vor]
  vor4     - StarCalc 4.0 Template [.vor]
  vor      - StarCalc 5.0 Template [.vor]
  xhtml    - XHTML [.xhtml]
  xls      - Microsoft Excel 97/2000/XP [.xls]
  xls5     - Microsoft Excel 5.0 [.xls]
  xls95    - Microsoft Excel 95 [.xls]
  xlt      - Microsoft Excel 97/2000/XP Template [.xlt]
  xlt5     - Microsoft Excel 5.0 Template [.xlt]
  xlt95    - Microsoft Excel 95 Template [.xlt]
'''

def _get_all():
    lst = set()
    for line in UNOCONV_HELP.splitlines():
        split = line.split()
        for s in split:
            if s.startswith('[') and s.endswith(']'):
                ext = s.strip('[.]')
                lst.add(ext)
    return lst

ALL_UNOCONV = tuple(_get_all())

@preview_converter(ALL_UNOCONV, 'pdf', keep=True, low_priority=True)
def unoconv_catch_all_renderer(in_path, out_path):
    # Converts EVERYTHING ELSE to PDF
    print "THIS IS IN PATH", in_path, out_path
    # Apply conversion
    #check_call(["unoconv", "-f", "pdf", in_path])
    return _unoconv(in_path, out_path)
    
    # Get 
    return ext

